name: Build & Release ISO (tagged or on-demand)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to build (e.g., v0.1)"
        required: true
        type: string

permissions:
  contents: write  # needed to create releases and (if needed) create tags

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          # If manual run, build the specified tag; otherwise use the pushed ref.
          ref: ${{ github.event_name == 'workflow_dispatch'
                   && format('refs/tags/{0}', inputs.tag)
                   || github.ref }}

      - name: Ensure build script is executable
        run: chmod +x build.sh

      - name: Build ISO image
        run: ./build.sh

      - name: Rename ISO to .iso
        run: |
          if [ -f ./rootfs.iso9660 ]; then
            mv ./rootfs.iso9660 ./rootfs.iso
          else
            echo "Expected ./rootfs.iso9660 not found" >&2
            exit 1
          fi

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: iso
          path: ./rootfs.iso
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: iso
          path: .

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ./rootfs.iso
          # On manual runs, release the input tag; on push, use the pushed tag.
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          body: "Automated release for tag **${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}**"
          draft: false
          prerelease: false
